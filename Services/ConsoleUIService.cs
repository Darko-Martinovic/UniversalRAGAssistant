using UniversalRAGAssistant.Models;
using UniversalRAGAssistant.Interfaces;

namespace UniversalRAGAssistant.Services
{
    public class ConsoleUIService : IConsoleUIService
    {
        private readonly Random _random = new Random();

        public void PrintStyledHeader()
        {
            Console.ForegroundColor = ConsoleColor.Magenta;
            Console.WriteLine("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
            Console.WriteLine("‚ïë                    UNIVERSAL RAG ASSISTANT                  ‚ïë");
            Console.WriteLine("‚ïë                    Powered by Azure OpenAI                  ‚ïë");
            Console.WriteLine("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
            Console.ResetColor();
        }

        public void PrintWelcomeMessage(AppMetadata metadata)
        {
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine($"\n{metadata.Icon} {metadata.Title}");
            if (!string.IsNullOrEmpty(metadata.Flag))
            {
                Console.WriteLine($"{metadata.Flag} {metadata.WelcomeMessage}");
            }
            Console.WriteLine($"\n{metadata.CapabilityDescription}");
            Console.WriteLine($"{metadata.AdditionalInfo}");
            Console.ResetColor();
        }

        public void PrintInstructions()
        {
            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("\nüí° INSTRUCTIONS:");
            Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
            Console.ForegroundColor = ConsoleColor.White;
            Console.WriteLine("‚Ä¢ Type your question and press Enter");
            Console.WriteLine("‚Ä¢ Type 'help' for example questions");
            Console.WriteLine("‚Ä¢ Type 'history' to see recent conversations");
            Console.WriteLine("‚Ä¢ Type 'stats' to see session statistics");
            Console.WriteLine("‚Ä¢ Type 'quit' or 'exit' to end the session");
            Console.WriteLine("‚Ä¢ Type 'info' to see data source information");
            Console.ResetColor();
        }

        public void PrintUserPrompt()
        {
            Console.ForegroundColor = ConsoleColor.Green;
            Console.Write("\nü§î You: ");
            Console.ResetColor();
        }

        public string ReadLineWithStyle()
        {
            return Console.ReadLine() ?? "";
        }

        public void PrintProcessingMessage()
        {
            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("üß† Processing your question...");
            Console.ResetColor();
        }

        public CancellationTokenSource ShowLoadingAnimation(string message)
        {
            var cts = new CancellationTokenSource();
            var spinner = new[] { "‚†ã", "‚†ô", "‚†π", "‚†∏", "‚†º", "‚†¥", "‚†¶", "‚†ß", "‚†á", "‚†è" };
            var i = 0;

            Task.Run(
                async () =>
                {
                    while (!cts.Token.IsCancellationRequested)
                    {
                        Console.ForegroundColor = ConsoleColor.Cyan;
                        Console.Write($"\r{spinner[i % spinner.Length]} {message}");
                        Console.ResetColor();
                        await Task.Delay(100, cts.Token);
                        i++;
                    }
                },
                cts.Token
            );

            return cts;
        }

        public void PrintAIResponse(string response, int conversationCount)
        {
            PrintAIResponse(response, conversationCount, null);
        }

        public void PrintAIResponse(string response, int conversationCount, TimeSpan? responseTime)
        {
            Console.ForegroundColor = ConsoleColor.Blue;
            Console.Write($"\nü§ñ Assistant: ");
            Console.ResetColor();

            var wrappedResponse = WrapText(response, 80, "   ");
            Console.WriteLine(wrappedResponse);

            if (responseTime.HasValue)
            {
                Console.ForegroundColor = ConsoleColor.DarkGray;
                Console.WriteLine($"   ‚è±Ô∏è  Response time: {responseTime.Value.TotalSeconds:F1}s");
                Console.ResetColor();
            }

            Console.WriteLine();
        }

        public void PrintSeparator()
        {
            Console.ForegroundColor = ConsoleColor.DarkGray;
            Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
            Console.ResetColor();
        }

        public void PrintHelpMessage(AppMetadata metadata)
        {
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine("\nüí° EXAMPLE QUESTIONS:");
            Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");

            var examples =
                metadata.HelpExamples.Length > 0 ? metadata.HelpExamples : GetDefaultHelpExamples();

            foreach (var example in examples)
            {
                Console.ForegroundColor = ConsoleColor.Yellow;
                Console.WriteLine($"‚Ä¢ {example}");
            }

            Console.ResetColor();
            Console.WriteLine();
        }

        public void PrintConversationHistory(List<(string question, string answer)> history)
        {
            if (history.Count == 0)
            {
                Console.ForegroundColor = ConsoleColor.DarkYellow;
                Console.WriteLine("üìù No conversation history yet. Ask me a question!");
                Console.ResetColor();
                return;
            }

            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine($"\nüìö CONVERSATION HISTORY ({history.Count} exchanges):");
            Console.ResetColor();

            for (int i = 0; i < Math.Min(history.Count, 5); i++) // Show last 5 exchanges
            {
                var (question, answer) = history[history.Count - 1 - i];
                Console.ForegroundColor = ConsoleColor.Blue;
                Console.WriteLine($"\n{history.Count - i}. Q: {question}");
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine($"   A: {answer.Substring(0, Math.Min(answer.Length, 100))}...");
            }
            Console.ResetColor();
            Console.WriteLine();
        }

        public void PrintTip(AppMetadata metadata)
        {
            var tips = metadata.Tips.Length > 0 ? metadata.Tips : GetDefaultTips();

            var tip = tips[_random.Next(tips.Length)];

            Console.ForegroundColor = ConsoleColor.DarkGreen;
            Console.WriteLine($"\n{tip}");
            Console.ResetColor();
        }

        public void PrintWarning(string message)
        {
            Console.ForegroundColor = ConsoleColor.DarkYellow;
            Console.WriteLine($"‚ö†Ô∏è  {message}");
            Console.ResetColor();
        }

        public void PrintError(string message)
        {
            Console.ForegroundColor = ConsoleColor.Red;
            Console.WriteLine($"‚ùå {message}");
            Console.ResetColor();
        }

        public void PrintGoodbye(AppMetadata metadata)
        {
            Console.ForegroundColor = ConsoleColor.Green;
            Console.WriteLine($"\nüôè Thank you for using {metadata.Title}!");
            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("üí∞ Happy shopping and save money on your groceries! üõí");
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine("üëã Goodbye!");
            Console.ResetColor();
        }

        public void PrintSessionSummary(
            int conversationCount,
            DateTime startTime,
            AppMetadata metadata
        )
        {
            var sessionDuration = DateTime.Now - startTime;

            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine("\nüìä SESSION SUMMARY:");
            Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
            Console.ForegroundColor = ConsoleColor.White;
            Console.WriteLine($"üí¨ Questions asked: {conversationCount}");
            Console.WriteLine($"‚è±Ô∏è  Session duration: {sessionDuration:mm\\:ss}");

            if (conversationCount > 0)
            {
                var avgTime = sessionDuration.TotalSeconds / conversationCount;
                Console.WriteLine($"‚ö° Average response time: ~{avgTime:F1}s per question");
            }

            Console.ForegroundColor = ConsoleColor.Green;
            Console.WriteLine($"‚ú® Thanks for exploring {metadata.Title} with me!");
            Console.ResetColor();
        }

        public void PrintSessionStats(int conversationCount, DateTime startTime)
        {
            var sessionDuration = DateTime.Now - startTime;

            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine("\nüìà CURRENT SESSION STATISTICS:");
            Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
            Console.ResetColor();

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine($"üó£Ô∏è  Questions asked: {conversationCount}");
            Console.WriteLine($"‚åö Session time: {sessionDuration:hh\\:mm\\:ss}");
            Console.WriteLine($"üìÖ Started at: {startTime:HH:mm:ss}");

            if (conversationCount > 0)
            {
                var avgTime = sessionDuration.TotalSeconds / conversationCount;
                Console.WriteLine($"‚ö° Average response time: ~{avgTime:F1}s per question");
            }

            Console.ResetColor();
        }

        public void PrintSessionEncouragement(int conversationCount, AppMetadata metadata)
        {
            var encouragements =
                metadata.Encouragements.Length > 0
                    ? metadata.Encouragements
                    : GetDefaultEncouragements();

            var encouragement = encouragements[_random.Next(encouragements.Length)];

            Console.ForegroundColor = ConsoleColor.Green;
            Console.WriteLine($"\n{encouragement}");
            Console.ResetColor();
        }

        public void PrintErrorAdvice(AppMetadata metadata)
        {
            var errorAdvice =
                metadata.ErrorAdvice.Length > 0 ? metadata.ErrorAdvice : GetDefaultErrorAdvice();

            var advice = errorAdvice[_random.Next(errorAdvice.Length)];

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine($"\nüí° {advice}");
            Console.ResetColor();
        }

        public void PrintDataSourceInfo(AppConfiguration appConfig)
        {
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine("\nüìä DATA SOURCE INFORMATION:");
            Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
            Console.ResetColor();

            Console.ForegroundColor = ConsoleColor.White;
            Console.WriteLine($"üìÅ Data Source Type: {appConfig.DataSource.Type}");

            switch (appConfig.DataSource.Type)
            {
                case DataSourceType.Json:
                    Console.WriteLine($"üìÑ JSON File: {appConfig.DataSource.FilePath}");
                    break;
                case DataSourceType.Csv:
                    Console.WriteLine($"üìä CSV File: {appConfig.DataSource.FilePath}");
                    break;
                case DataSourceType.TextFiles:
                    Console.WriteLine($"üìÅ Directory: {appConfig.DataSource.DirectoryPath}");
                    break;
            }

            Console.WriteLine($"üîç RAG Document Count: {appConfig.RagDocumentCount}");
            Console.WriteLine($"‚öôÔ∏è  Configuration File: appsettings.json");
            Console.ResetColor();
            Console.WriteLine();
        }

        private string WrapText(string text, int maxLength, string indent = "")
        {
            var words = text.Split(' ');
            var lines = new List<string>();
            var currentLine = indent;

            foreach (var word in words)
            {
                if ((currentLine + word).Length > maxLength)
                {
                    lines.Add(currentLine.TrimEnd());
                    currentLine = indent + word + " ";
                }
                else
                {
                    currentLine += word + " ";
                }
            }

            if (!string.IsNullOrWhiteSpace(currentLine))
            {
                lines.Add(currentLine.TrimEnd());
            }

            return string.Join("\n", lines);
        }

        private string[] GetDefaultHelpExamples()
        {
            return new[]
            {
                "üí¨ 'Tell me about available options and pricing'",
                "üìä 'Compare different products or services'",
                "üí∞ 'What are the best deals and discounts?'",
                "üè™ 'Where can I find the best prices?'",
                "üìà 'What are current market trends?'",
                "üîç 'Help me find specific information'",
                "üìã 'Give me a detailed comparison'",
                "üí° 'What are your recommendations?'"
            };
        }

        private string[] GetDefaultTips()
        {
            return new[]
            {
                "üí° Pro tip: Be specific in your questions for better answers!",
                "üí° Pro tip: Use keywords related to your domain for more relevant results.",
                "üí° Pro tip: Ask follow-up questions to dive deeper into topics.",
                "üí° Pro tip: Use the 'help' command to see example questions.",
                "üí° Pro tip: Check the conversation history to review previous answers."
            };
        }

        private string[] GetDefaultEncouragements()
        {
            return new[]
            {
                "üéâ Great question! Keep exploring to discover more insights!",
                "üöÄ You're doing great! Each question helps you learn more.",
                "üí™ Excellent progress! You're making the most of this assistant.",
                "üåü Wonderful! Your curiosity is leading to valuable discoveries.",
                "üéØ Perfect! You're asking the right questions to get the best information."
            };
        }

        private string[] GetDefaultErrorAdvice()
        {
            return new[]
            {
                "Try rephrasing your question with different keywords",
                "Check if your question is related to the available data domain",
                "Use the 'help' command to see example questions",
                "Make sure your question is clear and specific",
                "Try breaking down complex questions into simpler parts"
            };
        }
    }
}
